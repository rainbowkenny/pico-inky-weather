"""
Standalone weather display — Pimoroni Pico Inky Pack (296x128)
UK map embedded (correct Mercator proportions, letterboxed). Single file.
"""
import network, urequests, time, gc, math
from picographics import PicoGraphics, DISPLAY_INKY_PACK
from machine import Pin
import jpegdec

SSID     = "ASUS_E8_2G"
PASSWORD = "Bbdd1003"
BLACK = 0
WHITE = 15

WMO = {
    0:"Clear", 1:"Clear", 2:"P.Cloudy", 3:"Overcast",
    45:"Fog", 48:"Icy Fog",
    51:"Drizzle", 53:"Drizzle", 55:"Drizzle",
    61:"Lt Rain", 63:"Rain", 65:"Hvy Rain",
    71:"Lt Snow", 73:"Snow", 75:"Hvy Snow",
    80:"Showers", 81:"Showers", 82:"Showers",
    95:"Thunder", 96:"Thunder", 99:"Thunder",
}

# Map panel: x=148..295, y=14..127 (148x113px)
# UK drawn at correct Mercator proportions: 44x101px, offset (52,6) within panel
MAP_X, MAP_Y = 148, 14
_X_OFF, _MAP_W = 52, 44
_Y_OFF, _MAP_H = 6, 101
_LON_MIN, _LON_MAX = -6.5, 2.1
_LAT_MIN, _LAT_MAX = 49.8, 60.9

CITY_DOTS = {
    "Aberdeen": (222, 54), "Birmingham": (223, 96), "Brighton": (232, 111),
    "Bristol": (219, 105), "Cambridge": (233, 99), "Cardiff": (216, 105),
    "Coventry": (225, 97), "Derby": (225, 92), "Edinburgh": (216, 65),
    "Exeter": (215, 112), "Glasgow": (211, 65), "Inverness": (211, 51),
    "Ipswich": (239, 100), "Leeds": (225, 84), "Leicester": (227, 95),
    "Liverpool": (217, 88), "London": (232, 105), "Manchester": (221, 87),
    "Milton Keynes": (229, 100), "Newcastle": (224, 73), "Norwich": (239, 95),
    "Nottingham": (227, 92), "Oxford": (226, 103), "Peterborough": (232, 95),
    "Plymouth": (212, 115), "Reading": (228, 105), "Sheffield": (225, 88),
    "Southampton": (226, 110), "Stoke-on-Trent": (222, 91), "Swindon": (224, 104),
}

def latlon_to_dot(lat, lon):
    x = MAP_X + _X_OFF + int((lon - _LON_MIN) / (_LON_MAX - _LON_MIN) * _MAP_W)
    y = MAP_Y + _Y_OFF + int((_LAT_MAX - lat) / (_LAT_MAX - _LAT_MIN) * _MAP_H)
    x = max(MAP_X + _X_OFF, min(MAP_X + _X_OFF + _MAP_W, x))
    y = max(MAP_Y + _Y_OFF, min(MAP_Y + _Y_OFF + _MAP_H, y))
    return x, y

def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    if not wlan.isconnected():
        wlan.connect(SSID, PASSWORD)
        deadline = time.time() + 20
        while not wlan.isconnected() and time.time() < deadline:
            time.sleep(0.5)
    return wlan.isconnected()

def get_location():
    gc.collect()
    r = urequests.get("http://ip-api.com/json/?fields=lat,lon,city", timeout=10)
    d = r.json(); r.close(); gc.collect()
    return float(d["lat"]), float(d["lon"]), d["city"]

def get_weather(lat, lon):
    gc.collect()
    url = ("https://api.open-meteo.com/v1/forecast"
           "?latitude={}&longitude={}"
           "&current_weather=true"
           "&daily=temperature_2m_max,temperature_2m_min,weathercode,precipitation_sum"
           "&forecast_days=2&timezone=auto").format(lat, lon)
    r = urequests.get(url, timeout=15)
    d = r.json(); r.close(); gc.collect()
    return d

def deg_to_compass(deg):
    dirs = ["N","NE","E","SE","S","SW","W","NW"]
    return dirs[int((deg + 22.5) / 45) % 8]

def draw_wind_arrow(display, cx, cy, deg, size=7):
    """Draw arrow showing wind direction (deg = direction wind blows FROM)."""
    rad = math.radians(deg)
    # arrow points in the direction wind is blowing TO (deg + 180)
    dx = math.sin(rad)
    dy = -math.cos(rad)
    # shaft: tail at back, head at front
    tx, ty = int(cx - dx * size), int(cy - dy * size)  # tail
    hx, hy = int(cx + dx * size), int(cy + dy * size)  # head
    display.set_pen(BLACK)
    display.line(tx, ty, hx, hy)
    # arrowhead: two lines at ~145° from tip
    for offset in (145, -145):
        ar = math.radians(deg + offset)
        ax = int(hx + math.sin(ar) * (size // 2 + 2))
        ay = int(hy - math.cos(ar) * (size // 2 + 2))
        display.line(hx, hy, ax, ay)

def parse_time(wt):
    try:
        if len(wt) >= 16:
            d = wt[8:10].lstrip("0") or "0"
            m = wt[5:7].lstrip("0") or "0"
            return "{}/{} {}:{}".format(d, m, wt[11:13], wt[14:16])
    except Exception:
        pass
    return "--/-- --:--"

def show_error(display, msg):
    display.set_pen(WHITE); display.clear()
    display.set_pen(BLACK); display.set_font("bitmap8")
    display.text("ERROR", 4, 20, scale=2)
    display.set_font("bitmap6")
    display.text(str(msg)[:42], 4, 55, scale=1)
    display.update()

# ===== BUTTONS (A=GPIO12 prev, B=GPIO13 next, C=GPIO14 refresh) =====
# PULL_UP: pressed = value() == 0
_btn_a = Pin(12, Pin.IN, Pin.PULL_UP)
_btn_b = Pin(13, Pin.IN, Pin.PULL_UP)
_btn_c = Pin(14, Pin.IN, Pin.PULL_UP)

def btn_pressed():
    """Return 'a', 'b', 'c', or None (with simple debounce)."""
    if _btn_a.value() == 0:
        time.sleep_ms(50)
        return 'a' if _btn_a.value() == 0 else None
    if _btn_b.value() == 0:
        time.sleep_ms(50)
        return 'b' if _btn_b.value() == 0 else None
    if _btn_c.value() == 0:
        time.sleep_ms(50)
        return 'c' if _btn_c.value() == 0 else None
    return None

# Preset cities: (display_name, lat, lon)  — None = auto geolocation
HOME_CITY_IDX = 2   # Cambridge

PRESET_CITIES = [
    (None,          None,    None  ),   # 0: Auto
    ("London",     51.509, -0.118  ),
    ("Cambridge",  52.205,  0.122  ),   # HOME
    ("Manchester", 53.481, -2.243  ),
    ("Edinburgh",  55.953, -3.188  ),
    ("Birmingham", 52.486, -1.890  ),
    ("Glasgow",    55.862, -4.258  ),
    ("Leeds",      53.801, -1.549  ),
    ("Bristol",    51.454, -2.588  ),
    ("Newcastle",  54.978, -1.618  ),
]
_CITY_FILE = "city_idx.txt"

def load_city_idx():
    try:
        with open(_CITY_FILE) as f:
            v = int(f.read().strip())
            return v if 0 <= v < len(PRESET_CITIES) else 0
    except Exception:
        return 0

def save_city_idx(idx):
    try:
        with open(_CITY_FILE, "w") as f:
            f.write(str(idx))
    except Exception:
        pass

UK_MAP = (
    b'\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x00\x00\x01\x00\x01'
    b'\x00\x00\xff\xdb\x00C\x00\x03\x02\x02\x02\x02\x02\x03\x02\x02\x02\x03'
    b'\x03\x03\x03\x04\x06\x04\x04\x04\x04\x04\x08\x06\x06\x05\x06\t\x08\n'
    b'\n\t\x08\t\t\n\x0c\x0f\x0c\n\x0b\x0e\x0b\t\t\r\x11\r'
    b'\x0e\x0f\x10\x10\x11\x10\n\x0c\x12\x13\x12\x10\x13\x0f\x10\x10\x10\xff'
    b'\xc0\x00\x0b\x08\x00q\x00\x94\x01\x01\x11\x00\xff\xc4\x00\x1f\x00\x00'
    b'\x01\x05\x01\x01\x01\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02'
    b'\x03\x04\x05\x06\x07\x08\t\n\x0b\xff\xc4\x00\xb5\x10\x00\x02\x01\x03'
    b'\x03\x02\x04\x03\x05\x05\x04\x04\x00\x00\x01}\x01\x02\x03\x00\x04\x11'
    b'\x05\x12!1A\x06\x13Qa\x07"q\x142\x81\x91\xa1\x08'
    b'#B\xb1\xc1\x15R\xd1\xf0$3br\x82\t\n\x16\x17\x18'
    b"\x19\x1a%&'()*456789:CDE"
    b'FGHIJSTUVWXYZcdefg'
    b'hijstuvwxyz\x83\x84\x85\x86\x87\x88\x89'
    b'\x8a\x92\x93\x94\x95\x96\x97\x98\x99\x9a\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9'
    b'\xaa\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9'
    b'\xca\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8'
    b'\xe9\xea\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xff\xda\x00\x08\x01\x01'
    b'\x00\x00?\x00\xfa\xcf\xf6d\xfd\x99?f\xdd\x7f\xf6m\xf8Q'
    b'\xae\xeb\xbf\xb3\xe7\xc3]GR\xd4|\x0f\xa1]\xde^]\xf8'
    b'N\xc2i\xeeg\x92\xc2\x16\x92Y$h\x8b;\xb3\x12\xc5\x89'
    b'$\x92I\xafK\xff\x00\x86N\xfd\x96?\xe8\xda~\x15\x7f\xe1'
    b'\x1b\xa7\x7f\xf1\x9a?\xe1\x93\xbfe\x8f\xfa6\x9f\x85_\xf8F'
    b'\xe9\xdf\xfcf\x8f\xf8d\xef\xd9c\xfe\x8d\xa7\xe1W\xfe\x11\xba'
    b'w\xff\x00\x19\xa3\xfe\x19;\xf6X\xff\x00\xa3i\xf8U\xff\x00'
    b'\x84n\x9d\xff\x00\xc6h\xff\x00\x86N\xfd\x96?\xe8\xda~\x15'
    b'\x7f\xe1\x1b\xa7\x7f\xf1\x9a?\xe1\x93\xbfe\x8f\xfa6\x9f\x85_'
    b'\xf8F\xe9\xdf\xfcf\x8f\xf8d\xef\xd9c\xfe\x8d\xa7\xe1W\xfe'
    b'\x11\xbaw\xff\x00\x19\xa3\xfe\x19;\xf6X\xff\x00\xa3i\xf8U'
    b'\xff\x00\x84n\x9d\xff\x00\xc6h\xff\x00\x86N\xfd\x96?\xe8\xda'
    b'~\x15\x7f\xe1\x1b\xa7\x7f\xf1\x9a?\xe1\x93\xbfe\x8f\xfa6\x9f'
    b'\x85_\xf8F\xe9\xdf\xfcf\x8f\xf8d\xef\xd9c\xfe\x8d\xa7\xe1'
    b'W\xfe\x11\xbaw\xff\x00\x19\xa3\xfe\x19;\xf6X\xff\x00\xa3i'
    b'\xf8U\xff\x00\x84n\x9d\xff\x00\xc6h\xff\x00\x86N\xfd\x96?'
    b'\xe8\xda~\x15\x7f\xe1\x1b\xa7\x7f\xf1\x9a?\xe1\x93\xbfe\x8f\xfa'
    b'6\x9f\x85_\xf8F\xe9\xdf\xfcf\x8f\xf8d\xef\xd9c\xfe\x8d'
    b'\xa7\xe1W\xfe\x11\xbaw\xff\x00\x19\xa3\xfe\x19;\xf6X\xff\x00'
    b'\xa3i\xf8U\xff\x00\x84n\x9d\xff\x00\xc6h\xff\x00\x86N\xfd'
    b'\x96?\xe8\xda~\x15\x7f\xe1\x1b\xa7\x7f\xf1\x9a\xfc\x8b\xff\x00\x82'
    b'\xbb|=\xf0\x0f\xc3_\xdaK\xc3z\x17\xc3\x9f\x03\xf8\x7f\xc2'
    b'\xbal\xfe\x07\xb3\xbb\x96\xcfD\xd3!\xb1\x82I\xda\xfe\xfdZ'
    b'V\x8e\x15U.U\x11K\x11\x9c"\x8e\xc2\xbf]?d\xef'
    b'\xf95\x8f\x83\x7f\xf6O\xfc=\xff\x00\xa6\xe8+\xd5h\xa2\x8a'
    b"(\xa2\x8a(\xa2\x8a(\xa2\x8a+\xf1[\xfe\x0bW\xff\x00'"
    b"O\xe1o\xfb'\xf6?\xfaq\xd4k\xf5S\xf6N\xff\x00\x93"
    b'X\xf87\xff\x00d\xff\x00\xc3\xdf\xfan\x82\xbdV\x8a(\xa2'
    b'\x8a(\xa2\x8a(\xa2\x8a(\xa2\xbf\x15\xbf\xe0\xb5\x7f\xf2t\xfe'
    b'\x16\xff\x00\xb2\x7fc\xff\x00\xa7\x1dF\xbfU?d\xef\xf95'
    b'\x8f\x83\x7f\xf6O\xfc=\xff\x00\xa6\xe8+\xd5h\xaf\x03\xf1\xe7'
    b"\xc4mw\xe2'\x8f'\xf0\x17\xc2O\x89\x93h\x9aW\x85\xe0"
    b'\x94\xf8\x93^\xd0c\xb0\xbc\x98j\xc6c\x14ZR=\xcc7'
    b'6\xea\xf0\xac72]\xc2\xf1\xac\xd1\x99t\xf2\xac\x16I\x14'
    b'\xd0\x82\xc3\xe3\xc6\x84\xe6\xef@\xfd\xa1\xaf\xb5\x9b\x87\x1e[A'
    b'\xe3/\x0c\xe9\xb7\xb6J\x87\x92\xe8\x9adzt\xc2P@\x01'
    b'\x9av\x8fk81\xb3\x15t\x9f\xfbs\xf6\xa7\xff\x00\xa2\x9d'
    b'\xf0\xab\xff\x00\r\xde\xa3\xff\x00\xcb\xba\x86\xe2\x0f\xda\x07\xc4\x1b'
    b'\x7f\xe1"\xf8\xf7\x0e\x89\xe4g\xc9\xff\x00\x84\'\xc2v\x96>'
    b'v\xef\xbd\xf6\x8f\xedF\xd4\xb7\xe3\x0b\xb3\xca\xf2q\xbaM\xfe'
    b'fSbAa\xf1\xe3Bsw\xa0~\xd0\xd7\xda\xcd\xc3\x8f'
    b'-\xa0\xf1\x97\x86t\xdb\xdb%C\xc9tM2=:a('
    b' \x00\xcd;G\xb5\x9c\x18\xd9\x8a\xba^\x9b\xf6\x80\xf8\x91\xf0'
    b'\xfe\xc2\xe3[\xf8\xc1\xf0\xe3E\x93\xc3\x1aM\xbb\xc9\xa9x\x8b'
    b"\xc2\xfa\xd3\xcd,\x10\xc4\xbb\xa5\xd4'\xd3na\x88\xc1l\xb1"
    b'\xa4\x924P\\\xdeN\x87dh\x97\x192\x0f}\xa2\x8a('
    b'\xa2\x8a(\xaf\xc5o\xf8-_\xfc\x9d?\x85\xbf\xec\x9f\xd8\xff'
    b'\x00\xe9\xc7Q\xaf\xd5O\xd9;\xfeMc\xe0\xdf\xfd\x93\xff\x00'
    b'\x0f\x7f\xe9\xba\n\xf5Z\xf9F\xc7B\xf0\xcf\xed\x19\x1d\xcf\xc5'
    b'\x0f\x89\x1aL>(\xf0\xe6\xbdrn\xbc#\xa2j\xf9\xbb\xd2'
    b'\xedteP\x96wb\xcaO\xdc\x1b\x8b\x94\x12^\t\xe4\x81'
    b'n\xa1MA\xadY\xb6\xc5\x83\xe8\xfaf\x99\xa6\xe8\xbam\xa6'
    b'\x8d\xa3i\xf6\xd6\x1a}\x84\x11\xda\xdaZZ\xc4\xb1Co\n'
    b'(T\x8e4P\x15\x11T\x00\x14\x00\x00\x00\n\xb3E\x14V'
    b'o\x88\xfcM\xe1\xbf\x07h\xd7\x1e#\xf1w\x884\xdd\x0fI'
    b'\xb4\xd9\xf6\x8b\xfdJ\xee;kxw\xb8E\xdf$\x84*\xe5'
    b'\xd9Td\xf2X\x0e\xa6\xb2\xff\x00e/\x88\x9a=\xed\xb6\xa1'
    b'\xf0\x97\xc3\x0f}\xac\xf8K\xc2\xd6\xf0\x7f\xc2\x17\xe2;-6'
    b'\xe2m\x1e\xe7DH\xa3\x88X\xae\xa8\x13\xec\xd776\x93,'
    b'\xb0\xe1\x1d\x98\xc2 \xde\xf3\\Gx\xc9\xf4%\x14QE\x14'
    b'Q_\x8a\xdf\xf0Z\xbf\xf9:\x7f\x0b\x7f\xd9?\xb1\xff\x00\xd3'
    b"\x8e\xa3_\xaa\x9f\xb2w\xfc\x9a\xc7\xc1\xbf\xfb'\xfe\x1e\xff\x00"
    b'\xd3t\x15\xcd\xfe\xd4\x1e9\xd1\xee\xb4\xf4\xfd\x9fu9\x1fG'
    b'\x83\xe2^\x9f>\x8d}\xaf\xea0\xc9oa\r\xad\xd06\xed'
    b'eir\xe0C>\xadp\xaf"\xc1l\x18\xb2*Kp\xe8'
    b'\xeb\x12Aq\xb7E\x14W7\xf1\x06\xe3\xe2D\x1e\x1b\x9b\xfe'
    b'\x15V\x93\xe1\xab\xed~M\xd1\xc3\xff\x00\t\x0e\xa1=\xa5\x9c'
    b'\x19\x8d\xf6\xca\xdeD2\xbc\xbbd\xf2\xf3\x10\xf2\xf7)o\xde'
    b'!\x03>Oey\xf1G_!\xbe+x\x1f\xe3f\xa3o'
    b'\x92\x92i^\x10>\x1a\xf0\xd5\x8d\xc4`e\x1aIW]\x9f'
    b'RID\x87qh/\xa1FTDh\xca\xf9\xbeoe\xe0'
    b'\x9d\x7f\xf6i\xf8w\xab\xda\xf8\x97X\xfd\x9c\xbcm\xe1\x9f\x19'
    b'\xd9\x99\x1a\xdbX\xd5|\x19w\xe2\xcdvH\x9d\x1a?5\xf5'
    b'\x9d?\xfbE\xceQ\xa4\x84G-\xd7\x9a\xb1\xa0]\x8b\x11\x8f'
    b'w\xbd|7\xf8\xa9\xe0\xbf\x8b\x1a~\xa7\xa9x*\xefR\x92'
    b'=\x1bP:]\xfc:\x96\x8d{\xa5\xdc[]y\x10\xcf\xe5'
    b'\xbc\x17\x91E(\xccW\x10\xb8;v\x91 \xc1<\xd7]E'
    b'\x14QE\x14W\xe2\xb7\xfc\x16\xaf\xfeN\x9f\xc2\xdf\xf6O\xec'
    b'\x7f\xf4\xe3\xa8\xd7\xea\xa7\xec\x9d\xff\x00&\xb1\xf0o\xfe\xc9\xff'
    b'\x00\x87\xbf\xf4\xdd\x05zV\xad\xa4\xe9Z\xfe\x95{\xa1k\xba'
    b'e\xa6\xa3\xa6\xea6\xf2Z^Y\xdd\xc2\xb3As\x04\x8aV'
    b'H\xa4\x8d\x81WFRT\xa9\x04\x10H5\xe4\xda\x87\xec\xc3'
    b'\xe0\xed%Z\xf7\xe0\xfe\xad\xa9|9\xbe\x8f\x9b{M*g'
    b'\x97A\x00\x0c\xf9-\xa3H\xc6\xd2(^@\xaf)\xb4Kk'
    b'\x87>f\xdb\x88\xdaY\x19\xb9\x1f\x13^|`\xf8G\xa4_'
    b'\xf8\x93\xe2_\x87\xfc?\xe2/\t\xe8\xb6\xf2]\xea^$\xf0'
    b'\xd5\xc3\xda\\Z\xdbF\x86Y\xae\xe7\xd2n\x8byv\xf0\xc6'
    b'\xb2\x06\xf2/n\xe7r\x88R\x03\xe6\x14\x8b\xab\xd35\x085'
    b'm6\xd3U\xb5\x8e\xe68/`\x8e\xe25\xba\xb5\x92\xdae'
    b'WP\xc0I\x0c\xaa\xb2F\xf8<\xa3\xaa\xb2\x9c\x82\x01\x04U'
    b'\x9a(\xa2\xb9\xdb\xa85\xdf\x06\xf8\xbaO\x8a>\t\xb0\xfe\xd2'
    b'\xbf\x9e\xc6\xdfL\xd7tc"!\xd64\xfby&\x92\x15\xb7'
    b'\x92B\x16\x0b\xb8^\xe6\xe5\xa2,\xcb\x0c\xbet\x91LWt'
    b"W6\xbe\xa5\xe0\x0f\x8b\x1f\x0f\xbe'\xc7x<\x17\xe2$\xba"
    b'\xbc\xd3<\xbf\xed\x1d2\xe6\xdek-KN\xf37\xf9_j'
    b'\xb1\xb8D\xb9\xb6\xf3\x04l\xd1\xf9\xb1\xa7\x98\x80:nR\x18'
    b'\xf5\xd4QE\x14Q_\x8a\xdf\xf0Z\xbf\xf9:\x7f\x0b\x7f\xd9'
    b'?\xb1\xff\x00\xd3\x8e\xa3_\xaa\x9f\xb2w\xfc\x9a\xc7\xc1\xbf\xfb'
    b"'\xfe\x1e\xff\x00\xd3t\x15\xea\xb4W\x8d~\xd2\xf6\x1a\xbcz"
    b'W\x85|_\x16\x9b\xab\xeb\xfa\x17\x875\xfb{\x8ds\xc3\xfa'
    b'v\x9f=\xfc\xb71I\xfb\xbb{\xc8\xad-\xd1\xa5\xb9\x96\xce'
    b'\xe9\xad\xa7\x08KF\x91-\xc4\xc2).!\xb5h\xf2\xfc#'
    b'\xe3\x9f\x04\xfc@\xd3d\xd6|\x07\xe3\x1d\x0f\xc4\x9a|3\xb5'
    b'\xac\x97zF\xa1\r\xe4)0Uc\x19x\x99\x948WB'
    b'T\x9c\xe1\x94\xf7\x15\xb7E\x14W\t\xf1^\xf7\xe2\x9e\x97i'
    b'\xa6j\xdf\x0e\xb5\r\x16\xde\xc2\xda\xe1\xbf\xb7\xc5\xdf\x87.u'
    b'\x9b\xb4\xb4+\xc4\xf6\x96\xf6\xf7v\xed3F\xc3/\x08-#'
    b"\xc6\\\xc4\x1eTH'\xab\xa9\xfe\xce\x1f\x10>.\xd8\xe8\x9e"
    b' \xd5~9x\n\xf2\xc9\xe0\xfbF\x93\xe2_\tx>\xf2'
    b'\xc3X\xb4\xb4\xb9T2M\xa4\xea\xa9\xacJm\x9eX\x82\x81'
    b'"\xac\x91\xba\x90$\x8eh\xcbF\xdfLi6W:v\x95'
    b'e\xa7\xdej\xd7z\xa5\xc5\xad\xbcp\xcb}v\xb1,\xf7N'
    b'\xaa\x03M \x85\x12 \xecAb#DL\x93\xb5T`\x0b'
    b'tQE\x14W\xe2\xb7\xfc\x16\xaf\xfeN\x9f\xc2\xdf\xf6O\xec'
    b'\x7f\xf4\xe3\xa8\xd7\xea\xa7\xec\x9d\xff\x00&\xb1\xf0o\xfe\xc9\xff'
    b'\x00\x87\xbf\xf4\xdd\x05z\xad\x14W\x11\xe3\x8f\x82?\x08>%'
    b'jI\xae\xf8\xe7\xe1\xb7\x87\xb5}j\x0baii\xadMa'
    b'\x18\xd5,\xa3VfO\xb3^\xa8\x17\x16\xce\x8e\xee\xe8\xf1H'
    b'\x8d\x1b\x9d\xe8U\xb9\xae"\xf7\xf6z\xf1n\x80K|)\xf8'
    b'\xd3\xab\xe9\xd6\xf9\t\x1e\x95\xe2\xfbC\xe2[\x1bx\xc8\xcb\xb4'
    b'r\xb4\xb0jO)\x90n\r=\xf4\xc8\xaa\xee\x8b\x18_+'
    b'\xca\xc0\xba\xd5\xfe4x_#\xc6\xdf\x01\xef\xef!E\xfbD'
    b'\xfa\x8f\x835\x9b}f\xce\xda\xdc}\xe2\xf1\xdc\x0b;\xf9f'
    b'P\xac\xc6\x1b{9\xcb)A\x19\x92F1-\xef\t\xfc@'
    b'\xf0\x97\x8d\xa4\xbd\xb4\xd05G:\x8e\x97\xe5\xff\x00h\xe9W'
    b'\xb6\xb3X\xeaZ\x7f\x99\xb8\xc5\xf6\xab+\x84K\x8b\x7f1T'
    b'\xbay\xb1\xae\xf4\xc3\xae\xe5 \x9e\x86\x8a\xe0\xaf~\x02\xfc\x1c'
    b'\xbb\xd5\xae|Im\xf0\xefF\xd1\xfcAw<\x97R\xeb\xfa'
    b'\x14?\xd9:\xc0\x9aBL\xb2.\xa1fc\xbaG\x93s\x87'
    b'e\x90\x17Wum\xca\xec\x0b\xe1\xf8M\x16\x97 \xbf\xf0\xb7'
    b'\xc5\x0f\x8aZ6\xa9\x17\xfa\x8b\xe7\xf1\xce\xa7\xab\x08\xb3\xc3\x7f'
    b'\xa2j\x93]Y\xcb\x95,\xbf\xbd\x81\xf6\xee\xdc\xbb]U\xd6'
    b'\xdc:?\xc6\xfd&A\xa8h\xff\x00\xb4\x97\x88\xb5;\xc8\xbf'
    b'\xd5\xda\xf8\x9b\xc3\xfa5\xd6\x9b&x>tV6\xb6W-'
    b'\x80I_.\xe6<8B\xdb\xd44m\xb3\xe1\xdf\xda/\xfe'
    b'\x11\x03w\xe1\xdf\x8f\xab-\x86\xa5gt<\x9f\x10i\x1e\x17'
    b'\xd4\xc6\x85y`\xd1\xc6\xff\x00m\x9ad\x170i\x89\x13\xb4'
    b'\xf0\xc8.n\xbeQjn\x18\xc7\x14\xa8\x17\xd2|\x0b\xf1c'
    b'\xe1g\xc5\x0f\xb7\x7f\xc2\xb3\xf8\x97\xe1O\x16\xff\x00fy_'
    b'm\xfe\xc2\xd6m\xaf\xfe\xcb\xe6n\xf2\xfc\xdf%\xdbf\xef-'
    b'\xf6\xee\xc6v6:\x1a\xea\xe8\xa2\xbf\x15\xbf\xe0\xb5\x7f\xf2t'
    b'\xfe\x16\xff\x00\xb2\x7fc\xff\x00\xa7\x1dF\xbfU?d\xef\xf9'
    b'5\x8f\x83\x7f\xf6O\xfc=\xff\x00\xa6\xe8+\xd5h\xa2\xbc\xc7'
    b'\\\xfd\xa6\xbe\x00h:\x8d\xf6\x83/\xc5\xaf\x0ejZ\xf6\x9d'
    b'q%\xa5\xc6\x81\xa2]\x8d[Y\x13\xc6\xe5e\x89t\xeb?'
    b'6\xed\xde2\x18\xc8\xab\x11(\xa8\xec\xfbU\x18\x8c\xb7\xfd\xaa'
    b'\xfe\x19\xca\x8d\x16\x93\xe1\xef\x89z\x8d\xf3\x82\xb6\xd6k\xf0\xe7'
    b'^\xb472\x9f\xb9\x10\x9e\xee\xd2+xw6\x17\xcc\x9eX'
    b'\xe2\\\xe5\xdd\x14\x16\x15?\xe1\xa4|K\xff\x00F\xbd\xf1W'
    b'\xff\x00\x03<3\xff\x00\xcb\x8a\xe4\xa0_\x8a\xfe,\xf8\xbb\xa7'
    b'\xfc@\xf1\x8f\x83|!\xe1{+/\x0e_h\xd7i\xa2x'
    b'\x96\xe7S\x9fT\x95\xee\xade\xb43\x89,-F\xcb`\x97'
    b'\xfe^Y\xca\x9b\xe9v\x85\xde\xe5\xbb\xca(\xa2\x8a+\x9b\xf1'
    b'\x97\xc3?\x86\xff\x00\x11~\xc7\xff\x00\x0b\x07\xe1\xf7\x86\xbcO'
    b'\xfd\x9f\xe6}\x93\xfbgI\x82\xf7\xec\xfef\xdd\xfe_\x9a\x8d'
    b'\xb3v\xc4\xce1\x9d\xab\x9e\x82\xa8Yx?\xc7\xde\x0e"o'
    b'\x86?\x19\xbcMd\x88L\x9f\xd9~*\x9eO\x13\xe9\xd3\xca'
    b'\xc3kI3\xdeI\xfd\xa3\xf71\xb68o\xa1\x89]\x15\xf6'
    b'6\xe9V]D\xf8\xeb\xf13\xe1\xe2A?\xc6\x0f\x08hZ'
    b'\xb7\x87\x92\xe2\x0bk\xcf\x15xf\xe9\xed~\xc6\xb3L\xaao'
    b'/4\xdb\xb2V\xd2\xc6\x05v3N\x97\xd7,\xab\x1f\x9ab'
    b'T2y>\xfb_\x8a\xdf\xf0Z\xbf\xf9:\x7f\x0b\x7f\xd9?'
    b"\xb1\xff\x00\xd3\x8e\xa3_\xaa\x9f\xb2w\xfc\x9a\xc7\xc1\xbf\xfb'"
    b'\xfe\x1e\xff\x00\xd3t\x15\xea\xb4W5\xe3\xef\x1fh\x7f\x0e\xf4'
    b'5\xd65\x84\xb9\xba\x9e\xeau\xb2\xd34\xcb%W\xbc\xd5/'
    b'\x19Y\x92\xda\xdd\x19\x95Y\xca\xa3\xb1fe\x8e8\xe3\x92Y'
    b"^8\xa3\x92E\xf1\xdf\x86>\x18\xd5|'\xe0\xdbk\x0f\x10"
    b'\xcdi&\xb7}u}\xad\xeb&\xc9\x98\xda\x8dN\xfe\xee['
    b'\xdb\xc5\xb6\xde\x03\xfd\x9c\\\\L"\x0f\x97\x11\x84\x0cY\xb2'
    b'\xc7\xa9\xa2\x8a(\xa2\x8a(\xaf=\xd0\xbe-\xea\x9e9\xb1m'
    b'k\xe1o\xc1\x8f\x88^2\xd1\xe3\xb8\x9e\xc6]B\x0bK-'
    b"!#\xbb\x82V\x8a{\x7f'X\xba\xb3\x9d\x9a7B\xac\xc9"
    b'\x13F\x1c2o\xdf\x1c\x88\x9b\x90\xe8\x7f\xb4\xd6\xb1\xb0\xdb|'
    b'=\xf8\x7f\xe1\xfbK\xdcyw\x1a\x9f\x8b.\xae\xef\xb4\xf8\xdf'
    b'\xa3\xcfcob!\x96h\xc1\xcb\xc1\x15\xf0\x8d\x99J-\xce'
    b'\xd2%\xa9\xef?g\xbf\x8a\xde0\xb0\xbc\xf0\xf7\xc4o\x8e\x1a'
    b'G\xf6%\xed\xbc\x90\xcf\x0f\x85\xfc\x11\x05\x9c\xf7*\xeb\xb1\xa1'
    b'\x9c\xea\x97\x1a\x94\x12[\xb23\x86\x8c@\xac\xc7g\xef\x02\x86'
    b'G\xf6\x7f\t\xe8\x1f\xf0\x8axWF\xf0\xb7\xf6\xde\xab\xac\xff'
    b'\x00ci\xf6\xfa\x7f\xf6\x8e\xads\xf6\x8b\xeb\xcf*5O>'
    b'\xe2\\\x0f2g\xdb\xb9\xdf\x03s\x12p3_\x8d\x9f\xf0Z'
    b'\xbf\xf9:\x7f\x0b\x7f\xd9?\xb1\xff\x00\xd3\x8e\xa3_\xaa\x9f\xb2'
    b"w\xfc\x9a\xc7\xc1\xbf\xfb'\xfe\x1e\xff\x00\xd3t\x15\xea\xb4W"
    b'\x0f\xf13\xe0\xc7\x80\xbe.\xcb\xa2M\xe3xu\xd9$\xf0\xe5'
    b'\xc4\xd7zc\xe9~$\xd4\xb4\x96\x82y"1<\xb9\xb2\x9e'
    b'-\xcf\xe54\x88\x19\xb2Ue\x95W\x02G\r\xc5\x7f\xc37'
    b'x\x97\xfe\x8e\x87\xe2\xaf\xfe\x01\xf8g\xff\x00\x94\xf5I\xfe\x14'
    b'\xfe\xd2v\x88\xd7q\xfcU\xf8i\xab< \xc8\xb6\r\xe0\x8b'
    b'\xfd<]\x91\xc8\x84\xdd\x7fj\xdc}\x9f~6\xf9\xbeD\xdb'
    b'3\xbb\xca\x93\x1b\rG\xd2\xff\x00i\xdb4k\xbb\xdf\x84\xdf'
    b'\x0f\xae\xad\xe0\x06I\xa0\xd2\xbc}u-\xec\xa8\xbc\xb2[\xa5'
    b'\xc6\x95\x04/)\x00\x84Yg\x862\xc4\x06\x925\xcb\x8a\x9f'
    b'\xf0\x95|\\\xff\x00\xa3W\xf8\x93\xff\x00\x83O\x0c\x7f\xf2\xde'
    b'\xaa\x7f\xc2\xe9\xf0\xd7\xfd\t\x9f\x15\x7f\xf0\xd6x\x9b\xff\x00\x90'
    b'*\x9f\xfc4\xcf\xec\xdf\xff\x00G\x03\xf0\xdb\xff\x00\n\xbb\x0f'
    b'\xfe;^\x93E\x14W\x9fx\xef^O\x84S\xcf\xf1\x03C'
    b'\xf8\xb3\xe0\xef\x87O\xae\xcf\x1d\xa6\xa6\xfe-\x80M\xa4js'
    b'\xacx\x8aC\x17\xda\xedJ\xde\xacP\xec\x12\xa4\xc0\xbc)\xb2'
    b'T\x94Cnm\xf9\x9b\x1f\xdb+\xc4\xd62\x1bM\x1f\xe2/'
    b'\xc0\xef\x8b\xfa\x8d\xdf\xfc{\xe9^\x15\xbe\xbe\xb0\xd4\xa3\xdb\x92'
    b'\xdeU\x95\x97\xf6\xcd\xc5\xfeT\x97o.8\xbc\x94\x85\xdd\xb7'
    b'\xa9c\x17\xbb\xfc\x02\xf8\xab\xe3\x0f\x8b\x9e\x1a\xd65\xbf\x19\xfc'
    b'0\xbe\xf0E\xce\x9b\xac6\x9boor\xb7\xea\xb7\xd0\x0bk'
    b'y\x85\xd4b\xfe\xca\xcap\x9b\xe7\x92\x1f\x9a\x007@\xf8f'
    b'\x15\xe9\xd5\xf8\xad\xff\x00\x05\xab\xff\x00\x93\xa7\xf0\xb7\xfd\x93\xfb'
    b"\x1f\xfd8\xea5\xfa\xa9\xfb'\x7f\xc9\xac|\x1b\xff\x00\xb2\x7f"
    b'\xe1\xef\xfd7A^\xabU5m[J\xd04\xab\xddw]'
    b'\xd4\xed4\xed7N\xb7\x92\xee\xf2\xf2\xeee\x86\x0bh#R'
    b'\xd2K$\x8cB\xa2*\x82\xc5\x89\x00\x00I\xaf3\x7f\xda\xc7'
    b'\xf6b\xd8\xdfb\xfd\xa0~\x1fjw\x18>M\x96\x95\xe2+'
    b'[\xfb\xdb\xa7\xfe\x18\xad\xedm\xdd\xe6\xb8\x95\x8e\x15"\x89\x1a'
    b'Gb\x15U\x98\x80j?\xedW\xf0\xceTh\xb4\x9f\x0f|'
    b'K\xd4o\x9c\x15\xb6\xb3_\x87:\xf5\xa1\xb9\x94\xfd\xc8\x84\xf7'
    b'v\x91[\xc3\xb9\xb0\xbed\xf2\xc7\x12\xe7.\xe8\xa0\xb0\xa6\xff'
    b'\x00\xb4_\x8c\xaeQ\xad\xf4\xcf\xd9\x93\xe2\x0c7\x92\x82\x96\xf2'
    b'j\xba\xa7\x87\xe0\xb2I\x0f\n\xd7\x12A\xa8\xcf4q\x03\x82'
    b'\xed\x1c\x138\\\x95\x8eF\x01\x0f\x99\xea\xdf\xb6\xde\xaba\x7f'
    b'{\xe1\xbdW\\\xfd\x9d<5\xa9[M%\x8d\xcc\xb7\x7f\x17'
    b'\x1a\xee]2ub\x8e\xd2Y6\x9fn\xd34l\t0\x19'
    b'\xe0,T\xa1\x92<\xefZ\x90\xfe\xd0?\x1b\xbcM\x18\xb4\xf0'
    b'\x9f\xc4]+\xc5V\x9a\x8f\xfa=\xae\xa7\xe0o\x83z\xcd\xd4'
    b'7L\xdf!\x16Z\xc4\xba\x84\xfaBJ\xaf\x94\xf3\xae\x19\xed'
    b'\xe1\x95O\x9e6\xc7"\x8b\x11xS\xf6\xcd\xf1ZIkg'
    b'\xaf\xfcE\xb1\xb1\x03\xcb\xbf\xb5\xf1\xa7\x89|-\xa2\x9b\xd8\x9f'
    b"\x83\x1d\xb5\xc6\x81\xa5\xde\xdc'\xca\x18<\x82[Yc\xdd\x1b"
    b'B\xe5\xb2\xd1\xebh?\xb1V\xa5\xe2\x19\x9e_\x8c\xff\x00\x19'
    b'<u\xa9h\xb7v\xd3As\xe0\xfd\x1f\xc7>#\xfe\xcd\xb9'
    b'\x86\xe2\x17I\xad/\xee.\xf5\te\xbeD\x0c\xa1\x1e\x14\xb1'
    b"\x0f\xb5\xcc\xb12\xb8\x8a>\x87\xc1\xbf\xb0'\xec\xb7\xf0\xeb\xed"
    b'\x9f\xf0\xaf\xbc\x1b\xe2_\x0c\x7fhy\x7fk\xfe\xc6\xf1\xe7\x88'
    b',\xbe\xd1\xe5\xee\xd9\xe6yW\xab\xbfn\xf7\xc6s\x8d\xcd\x8e'
    b"\xa6\xba_\xf8e\x1f\x84\x7f\xf3\xff\x00\xf1'\xff\x00\x0e\x97\x89"
    b'\xff\x00\xf9aJ\x9f\xb2\x87\xc1\xad\xeb\xf6\xd8|m\xa9\xdb\xe4'
    b"y\xd6Z\xaf\xc4\x1f\x10_\xd9]'\xf1Eqkqz\xf0"
    b'\xdcD\xc3*\xf1J\x8d\x1b\xa9*\xca\xcaH6\xff\x00\xe1\x93'
    b'\xbfe\x8f\xfa6\x9f\x85_\xf8F\xe9\xdf\xfcf\xba\x0f\x05|'
    b'\x10\xf8/\xf0\xd7U\x97]\xf8s\xf0\x87\xc1^\x15\xd4\xa7\xb7'
    b'kIo4M\x02\xd2\xc6y fVh\x9aHcV('
    b'Y\x11\x8a\x93\x8c\xa2\x9e\xc2\xbbZ(\xaf\xc5o\xf8-_\xfc'
    b'\x9d?\x85\xbf\xec\x9f\xd8\xff\x00\xe9\xc7Q\xaf\xd5O\xd9;\xfe'
    b'Mc\xe0\xdf\xfd\x93\xff\x00\x0f\x7f\xe9\xba\n\xf5Z\xf3?\x1f'
    b"\xfe\xcd\x1f\x00\xfe'jW\x1a\xff\x00\x8c\xfe\x13\xf8z\xeb_"
    b'\xba\x9e\xd6\xe9\xfcAkj,\xb5\xa5\x9a\xd9\xa3h$\x8fQ'
    b'\xb7\xd9w\x1b\xa7\x93\x18\x0c\x92\x83\xb5B\xfd\xdc\x8a\xca\xff\x00'
    b'\x86Q\xf8G\xff\x00?\xff\x00\x12\x7f\xf0\xe9x\x9f\xff\x00\x96'
    b'\x15f\x1f\xd9?\xf6k1\x83\xac|\x12\xf0\x97\x88\xef?\xe5'
    b'\xa6\xa7\xe2m95\xcdJ\x7fO:\xfa\xfb\xce\xb9\x9bh\xc2'
    b"\xaf\x99#mED\\*\xaa\x87\xff\x00\xc3'~\xcb\x1f\xf4"
    b'm?\n\xbf\xf0\x8d\xd3\xbf\xf8\xcdzV\x93\xa4\xe9Z\x06\x95'
    b'e\xa1hZe\xa6\x9d\xa6\xe9\xd6\xf1\xdaY\xd9\xdaB\xb0\xc1'
    b'm\x04j\x168\xa3\x8d@TEP\x14(\x00\x00\x00\x15n'
    b"\x8a(\xa2\x8a(\xa2\x8a+\xf1[\xfe\x0bW\xff\x00'O\xe1"
    b"o\xfb'\xf6?\xfaq\xd4k\xe0\n(\xa2\x8a(\xa2\x8a("
    b'\xa2\x8a(\xa2\x8a(\xaf\xff\xd9'
)

# ===== MAIN =====
display = PicoGraphics(display=DISPLAY_INKY_PACK)
city_idx = load_city_idx()

# Show boot splash
display.set_pen(WHITE); display.clear()
display.set_pen(BLACK); display.set_font("bitmap8")
display.text("Connecting...", 10, 55, scale=1)
display.update()

if not connect_wifi():
    show_error(display, "WiFi failed")
    raise SystemExit

while True:
    try:
        # Resolve city
        preset = PRESET_CITIES[city_idx]
        if preset[0] is None:
            lat, lon, city = get_location()
        else:
            city, lat, lon = preset[0], preset[1], preset[2]
            # still need connect to fetch weather
            connect_wifi()

        data     = get_weather(lat, lon)
        cw       = data["current_weather"]
        daily    = data["daily"]

        temp     = int(cw["temperature"])
        desc     = WMO.get(int(cw["weathercode"]), "?")
        hmax     = int(daily["temperature_2m_max"][0])
        hmin     = int(daily["temperature_2m_min"][0])
        tmax     = int(daily["temperature_2m_max"][1])
        tmin     = int(daily["temperature_2m_min"][1])
        tmr_desc = WMO.get(int(daily["weathercode"][1]), "?")
        date_str = parse_time(cw.get("time", ""))
        wind_spd = int(cw.get("windspeed", 0))
        wind_deg = float(cw.get("winddirection", 0))
        wind_dir = deg_to_compass(wind_deg)
        rain_0   = daily["precipitation_sum"][0]   # today mm
        rain_1   = daily["precipitation_sum"][1]   # tomorrow mm
        rain_0   = "{:.1f}mm".format(rain_0) if rain_0 is not None else "--"
        rain_1   = "{:.1f}mm".format(rain_1) if rain_1 is not None else "--"
        gc.collect()

        # --- DRAW ---
        display.set_pen(WHITE); display.clear()

        # 1. UK map
        j = jpegdec.JPEG(display)
        j.open_RAM(UK_MAP)
        j.decode(MAP_X, MAP_Y)

        # 2. Mask left panel
        display.set_pen(WHITE); display.rectangle(0, 0, MAP_X, 128)

        # 3. Header — show city name + page indicator + time
        display.set_pen(BLACK); display.rectangle(0, 0, 296, 14)
        display.set_pen(WHITE); display.set_font("bitmap6")
        # City label: show preset name or auto-resolved name
        label = city[:14]
        display.text(label, 3, 4, scale=1)
        # Page indicator e.g. "2/10"
        page_str = "{}/{}".format(city_idx, len(PRESET_CITIES) - 1) if city_idx > 0 else "Auto"
        display.text(page_str, 160, 4, scale=1)
        display.text(date_str[6:] if len(date_str) > 6 else date_str, 220, 4, scale=1)

        # 4. Left: today
        display.set_pen(BLACK); display.set_font("bitmap8")
        display.text("{}C".format(temp), 4, 18, scale=3)
        display.set_font("bitmap6")
        display.text(desc, 4, 44, scale=1)
        display.text("H:{}  L:{}".format(hmax, hmin), 4, 54, scale=1)
        draw_wind_arrow(display, 10, 69, wind_deg, size=6)
        display.set_font("bitmap6")
        display.text("{} {}km/h".format(wind_dir, wind_spd), 22, 64, scale=1)
        display.text("Rain:{}".format(rain_0), 4, 74, scale=1)

        # 5. Left: tomorrow
        display.set_pen(BLACK); display.line(4, 84, 143, 84)
        display.set_font("bitmap6")
        display.text("Tmr:{}".format(tmr_desc), 4, 88, scale=1)
        display.text("H:{}  L:{}".format(tmax, tmin), 4, 98, scale=1)
        display.text("Rain:{}".format(rain_1), 4, 108, scale=1)

        # 6. Divider
        display.set_pen(BLACK); display.line(148, 14, 148, 127)

        # 7. Location dot
        if city in CITY_DOTS:
            dx, dy = CITY_DOTS[city]
        else:
            dx, dy = latlon_to_dot(lat, lon)
        display.set_pen(BLACK); display.circle(dx, dy, 5)
        display.set_pen(WHITE); display.circle(dx, dy, 2)
        display.set_pen(BLACK)

        display.line(0, 127, 295, 127)
        display.update()

    except Exception as e:
        try:
            show_error(display, e)
        except Exception:
            pass
        time.sleep(30)
        continue

    # --- BUTTON POLL (wait up to 10 min, then auto-refresh) ---
    deadline = time.time() + 600
    while time.time() < deadline:
        btn = btn_pressed()
        if btn == 'a':
            city_idx = (city_idx - 1) % len(PRESET_CITIES)
            save_city_idx(city_idx)
            break
        elif btn == 'b':
            city_idx = (city_idx + 1) % len(PRESET_CITIES)
            save_city_idx(city_idx)
            break
        elif btn == 'c':
            city_idx = HOME_CITY_IDX   # go home (Cambridge)
            save_city_idx(city_idx)
            break
        time.sleep_ms(100)
    # loop → re-fetch and redraw
