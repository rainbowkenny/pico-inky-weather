"""
Standalone weather display â€” Pimoroni Pico Inky Pack (296x128)
UK map embedded (correct Mercator proportions, letterboxed). Single file.
"""
import network, urequests, time, gc
from picographics import PicoGraphics, DISPLAY_INKY_PACK
import jpegdec

SSID     = "ASUS_E8_2G"
PASSWORD = "Bbdd1003"
BLACK = 0
WHITE = 15

WMO = {
    0:"Clear", 1:"Clear", 2:"P.Cloudy", 3:"Overcast",
    45:"Fog", 48:"Icy Fog",
    51:"Drizzle", 53:"Drizzle", 55:"Drizzle",
    61:"Lt Rain", 63:"Rain", 65:"Hvy Rain",
    71:"Lt Snow", 73:"Snow", 75:"Hvy Snow",
    80:"Showers", 81:"Showers", 82:"Showers",
    95:"Thunder", 96:"Thunder", 99:"Thunder",
}

# Map panel: x=148..295, y=14..127 (148x113px)
# UK drawn at correct Mercator proportions: 44x101px, offset (52,6) within panel
MAP_X, MAP_Y = 148, 14
_X_OFF, _MAP_W = 52, 44
_Y_OFF, _MAP_H = 6, 101
_LON_MIN, _LON_MAX = -6.5, 2.1
_LAT_MIN, _LAT_MAX = 49.8, 60.9

CITY_DOTS = {
    "Aberdeen": (222, 54), "Birmingham": (223, 96), "Brighton": (232, 111),
    "Bristol": (219, 105), "Cambridge": (233, 99), "Cardiff": (216, 105),
    "Coventry": (225, 97), "Derby": (225, 92), "Edinburgh": (216, 65),
    "Exeter": (215, 112), "Glasgow": (211, 65), "Inverness": (211, 51),
    "Ipswich": (239, 100), "Leeds": (225, 84), "Leicester": (227, 95),
    "Liverpool": (217, 88), "London": (232, 105), "Manchester": (221, 87),
    "Milton Keynes": (229, 100), "Newcastle": (224, 73), "Norwich": (239, 95),
    "Nottingham": (227, 92), "Oxford": (226, 103), "Peterborough": (232, 95),
    "Plymouth": (212, 115), "Reading": (228, 105), "Sheffield": (225, 88),
    "Southampton": (226, 110), "Stoke-on-Trent": (222, 91), "Swindon": (224, 104),
}

def latlon_to_dot(lat, lon):
    x = MAP_X + _X_OFF + int((lon - _LON_MIN) / (_LON_MAX - _LON_MIN) * _MAP_W)
    y = MAP_Y + _Y_OFF + int((_LAT_MAX - lat) / (_LAT_MAX - _LAT_MIN) * _MAP_H)
    x = max(MAP_X + _X_OFF, min(MAP_X + _X_OFF + _MAP_W, x))
    y = max(MAP_Y + _Y_OFF, min(MAP_Y + _Y_OFF + _MAP_H, y))
    return x, y

def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    if not wlan.isconnected():
        wlan.connect(SSID, PASSWORD)
        deadline = time.time() + 20
        while not wlan.isconnected() and time.time() < deadline:
            time.sleep(0.5)
    return wlan.isconnected()

def get_location():
    gc.collect()
    r = urequests.get("http://ip-api.com/json/?fields=lat,lon,city", timeout=10)
    d = r.json(); r.close(); gc.collect()
    return float(d["lat"]), float(d["lon"]), d["city"]

def get_weather(lat, lon):
    gc.collect()
    url = ("https://api.open-meteo.com/v1/forecast"
           "?latitude={}&longitude={}"
           "&current_weather=true"
           "&daily=temperature_2m_max,temperature_2m_min,weathercode"
           "&forecast_days=2&timezone=auto").format(lat, lon)
    r = urequests.get(url, timeout=15)
    d = r.json(); r.close(); gc.collect()
    return d

def parse_time(wt):
    try:
        if len(wt) >= 16:
            d = wt[8:10].lstrip("0") or "0"
            m = wt[5:7].lstrip("0") or "0"
            return "{}/{} {}:{}".format(d, m, wt[11:13], wt[14:16])
    except Exception:
        pass
    return "--/-- --:--"

def show_error(display, msg):
    display.set_pen(WHITE); display.clear()
    display.set_pen(BLACK); display.set_font("bitmap8")
    display.text("ERROR", 4, 20, scale=2)
    display.set_font("bitmap6")
    display.text(str(msg)[:42], 4, 55, scale=1)
    display.update()

UK_MAP = (
    b'\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x00\x00\x01\x00\x01\x00\x00'
    b'\xff\xdb\x00C\x00\x03\x02\x02\x02\x02\x02\x03\x02\x02\x02\x03\x03\x03\x03\x04'
    b'\x06\x04\x04\x04\x04\x04\x08\x06\x06\x05\x06\t\x08\n\n\t\x08\t\t\n'
    b'\x0c\x0f\x0c\n\x0b\x0e\x0b\t\t\r\x11\r\x0e\x0f\x10\x10\x11\x10\n\x0c'
    b'\x12\x13\x12\x10\x13\x0f\x10\x10\x10\xff\xc0\x00\x0b\x08\x00q\x00\x94\x01\x01'
    b'\x11\x00\xff\xc4\x00\x1f\x00\x00\x01\x05\x01\x01\x01\x01\x01\x01\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x01\x02\x03\x04\x05\x06\x07\x08\t\n\x0b\xff\xc4\x00\xb5\x10'
    b'\x00\x02\x01\x03\x03\x02\x04\x03\x05\x05\x04\x04\x00\x00\x01}\x01\x02\x03\x00'
    b'\x04\x11\x05\x12!1A\x06\x13Qa\x07"q\x142\x81\x91\xa1\x08'
    b'#B\xb1\xc1\x15R\xd1\xf0$3br\x82\t\n\x16\x17\x18\x19\x1a'
    b"%&'()*456789:CDEFGHI"
    b'JSTUVWXYZcdefghijstu'
    b'vwxyz\x83\x84\x85\x86\x87\x88\x89\x8a\x92\x93\x94\x95\x96\x97\x98'
    b'\x99\x9a\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba'
    b'\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xe1\xe2'
    b'\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xff\xda'
    b'\x00\x08\x01\x01\x00\x00?\x00\xfa\xcf\xf6d\xfd\x99?f\xdd\x7f\xf6m'
    b'\xf8Q\xae\xeb\xbf\xb3\xe7\xc3]GR\xd4|\x0f\xa1]\xde^]\xf8'
    b'N\xc2i\xeeg\x92\xc2\x16\x92Y$h\x8b;\xb3\x12\xc5\x89$\x92'
    b'I\xafK\xff\x00\x86N\xfd\x96?\xe8\xda~\x15\x7f\xe1\x1b\xa7\x7f\xf1'
    b'\x9a?\xe1\x93\xbfe\x8f\xfa6\x9f\x85_\xf8F\xe9\xdf\xfcf\x8f\xf8'
    b'd\xef\xd9c\xfe\x8d\xa7\xe1W\xfe\x11\xbaw\xff\x00\x19\xa3\xfe\x19;'
    b'\xf6X\xff\x00\xa3i\xf8U\xff\x00\x84n\x9d\xff\x00\xc6h\xff\x00\x86'
    b'N\xfd\x96?\xe8\xda~\x15\x7f\xe1\x1b\xa7\x7f\xf1\x9a?\xe1\x93\xbfe'
    b'\x8f\xfa6\x9f\x85_\xf8F\xe9\xdf\xfcf\x8f\xf8d\xef\xd9c\xfe\x8d'
    b'\xa7\xe1W\xfe\x11\xbaw\xff\x00\x19\xa3\xfe\x19;\xf6X\xff\x00\xa3i'
    b'\xf8U\xff\x00\x84n\x9d\xff\x00\xc6h\xff\x00\x86N\xfd\x96?\xe8\xda'
    b'~\x15\x7f\xe1\x1b\xa7\x7f\xf1\x9a?\xe1\x93\xbfe\x8f\xfa6\x9f\x85_'
    b'\xf8F\xe9\xdf\xfcf\x8f\xf8d\xef\xd9c\xfe\x8d\xa7\xe1W\xfe\x11\xba'
    b'w\xff\x00\x19\xa3\xfe\x19;\xf6X\xff\x00\xa3i\xf8U\xff\x00\x84n'
    b'\x9d\xff\x00\xc6h\xff\x00\x86N\xfd\x96?\xe8\xda~\x15\x7f\xe1\x1b\xa7'
    b'\x7f\xf1\x9a?\xe1\x93\xbfe\x8f\xfa6\x9f\x85_\xf8F\xe9\xdf\xfcf'
    b'\x8f\xf8d\xef\xd9c\xfe\x8d\xa7\xe1W\xfe\x11\xbaw\xff\x00\x19\xa3\xfe'
    b'\x19;\xf6X\xff\x00\xa3i\xf8U\xff\x00\x84n\x9d\xff\x00\xc6h\xff'
    b'\x00\x86N\xfd\x96?\xe8\xda~\x15\x7f\xe1\x1b\xa7\x7f\xf1\x9a\xfc\x8b\xff'
    b'\x00\x82\xbb|=\xf0\x0f\xc3_\xdaK\xc3z\x17\xc3\x9f\x03\xf8\x7f\xc2'
    b'\xbal\xfe\x07\xb3\xbb\x96\xcfD\xd3!\xb1\x82I\xda\xfe\xfdZV\x8e'
    b'\x15U.U\x11K\x11\x9c"\x8e\xc2\xbf]?d\xef\xf95\x8f\x83'
    b'\x7f\xf6O\xfc=\xff\x00\xa6\xe8+\xd5h\xa2\x8a(\xa2\x8a(\xa2\x8a'
    b"(\xa2\x8a+\xf1[\xfe\x0bW\xff\x00'O\xe1o\xfb'\xf6?\xfa"
    b'q\xd4k\xf5S\xf6N\xff\x00\x93X\xf87\xff\x00d\xff\x00\xc3\xdf'
    b'\xfan\x82\xbdV\x8a(\xa2\x8a(\xa2\x8a(\xa2\x8a(\xa2\xbf\x15\xbf'
    b'\xe0\xb5\x7f\xf2t\xfe\x16\xff\x00\xb2\x7fc\xff\x00\xa7\x1dF\xbfU?'
    b'd\xef\xf95\x8f\x83\x7f\xf6O\xfc=\xff\x00\xa6\xe8+\xd5h\xa2\x8a'
    b'(\xaf\x9b|a\xe3\x8f\x8b\x9a\xf7\xc6\x9f\x17\xdb\xfc9\xf8\x90\xba\x0e'
    b"\x91\xe0x\xf4\xed\x0f\xfb'R\xd1-\xaf\xac/ui-\xbe\xdbu"
    b'<\xea\xbe]\xd3\xc5\xf6K\xfd9b\xf2\xae\xe0\xc4\xd0\xca]\x19\x06'
    b'%b\xeb\x9f\xb4Lw\xb1x\x9e\xf3\xe2\xa6\x8d\x7f\x7fa\xfe\xaf\xc3'
    b"\xb6^\x1f\x8fL\xd0\xb5\x18\xc6r\x97\r+]\xdfE3\x06`'"
    b'\x8a\xe7\xcb\x8c\xac,m\xa5\t$s\xfb\xaf\xc3\xdf\x1a\xe9_\x12\xbc'
    b'\x01\xe1\xaf\x88\xda\x15\xbd\xdc\x1ao\x8a\xb4{-n\xce+\xb4U\x9e'
    b'8.aI\xa3Y\x15Y\x948W\x00\x80\xcc3\x9c\x13\xd6\xba\n'
    b'(\xa2\x8a(\xa2\xbf\x15\xbf\xe0\xb5\x7f\xf2t\xfe\x16\xff\x00\xb2\x7fc'
    b'\xff\x00\xa7\x1dF\xbfU?d\xef\xf95\x8f\x83\x7f\xf6O\xfc=\xff'
    b'\x00\xa6\xe8+\xd5h\xa2\x8a+\x94\xf8\xb1\xe3\xaf\xf8U\xff\x00\x0b<'
    b"e\xf13\xfb/\xfbO\xfe\x11/\x0f\xea:\xef\xd8\xbc\xff\x00'\xed"
    b'_e\xb6\x92o+\xcc\xda\xdb7y{wmlg88\xc5x'
    b'\x8f\xc3\xdf\t\xc9\xe0o\x04h\xbe\x14\xb9\xd5\x1bU\xbc\xd3\xac\xe3\x8e'
    b'\xff\x00Sx\xf6K\xa9^\x91\xba\xe6\xf6PY\x89\x96y\x9aI\xa4'
    b'fffy\x19\x99\x98\x92\xc7\xa1\xa9\xff\x00c\xddcN\xd5>\x15'
    b'\xea\x90h\xf7qjV\x16\xbe1\xf1\x1c\xd6\xba\xbd\x9c\x8b6\x9f\xaa'
    b'C{\xa9M\xa8\xa4\xb6s\xa9+:F\xb7\xc2\xdeF\x1c-\xcd\xb5'
    b'\xccc>^\xe6\xf7\x1a(\xa2\x8a(\xa2\xbf\x15\xbf\xe0\xb5\x7f\xf2t'
    b'\xfe\x16\xff\x00\xb2\x7fc\xff\x00\xa7\x1dF\xbfU?d\xef\xf95\x8f'
    b'\x83\x7f\xf6O\xfc=\xff\x00\xa6\xe8+\xd5h\xa2\x8a+\xc5\x7fj\xc9'
    b'\xa4\x9f\xc1\x9e\x14\xf0\xe4\x904V:\xe7\x8et\x14\xbc\xd4\xcf\xfa\xad'
    b'4Z]\rF\x06\x93\xb6..lm\xecS,\xbf\xbd\xbe\x8b\x1b'
    b'\xdblRQ\xae\x0f\xc7\xb2jSk\xda~\x9d\xae|6\xf1\x17\x8c'
    b'|\x12\xf04\xb7\xfa_\x87\xe7\xd3\x96MFp\xd8\x16\xd7\xdfn\xba'
    b"\xb6Qe\xb7\x0c\xd1De7'1\xcd\xe5\xc0\x8f\x15\xe7\xd0\xbf\r"
    b"\xbe+x'\xe2\xd6\x9d\xa9j\x9e\x08\xbc\xd4\xa6\x8bG\xd4\x0e\x97\x7f"
    b'\x16\xa3\xa3^\xe9w\x16\xf7B\x08g\xf2\xde\x0b\xc8\xa2\x94f+\x88'
    b'\\\x1d\xbbHq\x82y\xae\xbe\x8a(\xa2\x8a(\xaf\xc5o\xf8-_'
    b'\xfc\x9d?\x85\xbf\xec\x9f\xd8\xff\x00\xe9\xc7Q\xaf\xd5O\xd9;\xfeM'
    b'c\xe0\xdf\xfd\x93\xff\x00\x0f\x7f\xe9\xba\n\xf5Z(\xa2\x8a\xa9\xabi'
    b':V\xbf\xa5^\xe8Z\xee\x99i\xa8\xe9\xba\x8d\xbc\x96\x97\x96wp'
    b'\xac\xd0\\\xc1"\x95\x92)#`U\xd1\x94\x95*A\x04\x12\r|'
    b'\xdf\xa6\xe9\xba\xb7\xc3\x1dz\xc3\xe0\xef\x8a\xb5;\x9dZh\xf4\xb9n'
    b'\xfc=\xad\xdcLf\x9fY\xd3mZ\x08ek\xb2Ie\xbd\x85\xae'
    b'-\x96f8I\xcc\xc94X/5\xbd\xb7GP|\t\xd4b\xf0'
    b'\xaf\xc5\xaf\x1d\xf8\x12\xfc~\xf7\xc6\xaf\x17\x8e4\xa9\xf9\xfd\xea\xc1i'
    b'c\xa6_[m\x00\xed\xf2\x0c\x1at\xbec\xb2\xf9\x9f\xda;QO'
    b"\x91#\x1f\x7f\xa2\x8a(\xa2\x8a+\xf1[\xfe\x0bW\xff\x00'O\xe1"
    b"o\xfb'\xf6?\xfaq\xd4k\xf5S\xf6N\xff\x00\x93X\xf87\xff"
    b'\x00d\xff\x00\xc3\xdf\xfan\x82\xbdV\x8a(\xa2\x8a\xf9\xc3\xc6\xd1\xc9'
    b'i\xfbQ\xf8\x82[\xb4hSU\xf0\x0f\x87\xd6\xc1\xa4\x1bE\xd9\xb4'
    b'\xd4u\x8f\xb5\x08\x89\xff\x00Xa\xfbe\x9f\x99\xb7;>\xd3\x06\xec'
    b'y\x89\x9dz\xe2\xbc)\xa0\xf8\xbb\xc7\x1f\xb4-\xbe\x97\xad\xf8\xc3G'
    b'\xd1l<\x15qk\xe2\xdf\x0e\xda\xdb\xe8\xb26\xa1\xa8\xdb5\xac\xb6'
    b'w[/%\xba\xf2K#\xcd<7\x11\x8b9\x04v\xf7\xf6\x8c\xb2'
    b'\xc7<\xd1\xc9\x0f\xd5\xb4QE\x14QE~+\x7f\xc1j\xff\x00\xe4'
    b'\xe9\xfc-\xff\x00d\xfe\xc7\xff\x00N:\x8d~\xaa~\xc9\xdf\xf2k'
    b'\x1f\x06\xff\x00\xec\x9f\xf8{\xff\x00M\xd0W\xaa\xd1E\x14Q\\\xcf'
    b'\xc4\x1f\x87\xda\x0f\xc4}\x04h\xba\xd3\\\xdbMm:\xde\xe9\xba\x95'
    b'\x93*^i\x97\x8a\xac\xa9sn\xec\xac\xaa\xe1]\xd4\xab+G$'
    b'rI\x14\xa9$RI\x1bx\x93\x8f\x17\xf8\x1b]\xb5\xf0g\xc4\xe9'
    b'\xf4\xdb\x8b\xcdKq\xd1\xb5\xdd6\xceKM?WeC$\x96\xc2'
    b'\x19%\x95\xad\xae\xe3Uv\xf2ZY<\xd8\x90\xcd\x136\xcb\x88\xad'
    b'b\xf1G\x80\xfc-\xe3\x19l\xaf5\xbd:A\xa8\xe9\x9eg\xf6v'
    b'\xabeu5\x8e\xa5\xa7\xf9\x81D\xbfe\xbd\xb7d\xb8\xb7\xf3\x15B'
    b'?\x95"\xefL\xa3eI\x06O\x01\xfcD\xf1\x7f\xc3_\x8a>\x1e'
    b'\xf8u\xe3\x1f\x1a_k>\x06\xf1\x1e\x9fy\x16\x9d\xa9\xebV\x12M'
    b'u\xa6j\xb1\xcfe\r\x8e\x9d.\xa7\x1e#h\xa7\x8ei\x96#x'
    b'\xads,\xf1\xed73\xc9*F>\x94\xa2\x8a(\xa2\x8a\xfcV\xff'
    b'\x00\x82\xd5\xff\x00\xc9\xd3\xf8[\xfe\xc9\xfd\x8f\xfe\x9cu\x1a\xfdT\xfd'
    b'\x93\xbf\xe4\xd6>\r\xff\x00\xd9?\xf0\xf7\xfe\x9b\xa0\xafU\xa2\x8a('
    b'\xa2\xb9\xdf\x1c\xfcC\xf0O\xc3M\x195\xef\x1dx\x92\xcbG\xb4\x9e'
    b"qij'rf\xbd\xbadfK[hW2\\\xdc8G\xd9"
    b'\x04J\xf2\xb9\x18Ec\xc5x\x17\x8f\xfco\xa8\xfcn\xf1_\x80\xae'
    b'\xfc#\xe0\xedWN\xf0\xb7\x83\xfcA6\xbbs\xacx\x82\x194\xc9'
    b'\xb5\r\xdaM\xfd\x92Eia"}\xa8m\x96\xf1\xbc\xc6\xbaK\\'
    b"\x08\xd4\xc4'Y\x03\xafOU\xb5-7N\xd6t\xeb\xad\x1fX\xb0"
    b'\xb6\xbe\xb0\xbe\x81\xed\xae\xadnbYa\x9e\x17R\xaf\x1b\xa3\x02\xac'
    b'\xac\xa4\x82\xa4\x10A \xd2\xfc;\xf1\xbf\x89\xbe\x1e\xf8\xcb\xc3\x9f\x0e'
    b'|K\xe2MO\xc5Z\x17\x8c/&\xd2\xf4;\xadE\xd2MGI'
    b'\xba\x82\xca\xe2\xec[\xcb0U7v\xadmg(\x13L^\xe9f'
    b'A\xe6Ir.\x0b[}\x01E\x14QE~+\x7f\xc1j\xff\x00'
    b'\xe4\xe9\xfc-\xff\x00d\xfe\xc7\xff\x00N:\x8d~\xaa~\xc9\xdf\xf2'
    b'k\x1f\x06\xff\x00\xec\x9f\xf8{\xff\x00M\xd0W\xaa\xd1E\x14Q^'
    b'\t\xfbC]\x7fj\xfcR\xf8M\xe0\xdf/\xca\xfb\x0c\xda\xdf\x8d~'
    b'\xd3\x9d\xdb\xfe\xc7f\xbag\xd9\xb6q\x8d\xff\x00\xdb\xdeo\x99\x93\xb7'
    b"\xec\xbbv\x9f3r>\x8a\xc8\xf1O\x89l\xfc'\xa3\x9dZ\xee\xda"
    b'\xe6\xe9\xa4\xb9\xb5\xb0\xb4\xb5\xb6\nf\xbb\xbc\xba\xb8\x8e\xde\xd6\xdd\x0b'
    b"\xb2\xa2\xb4\xb3\xcd\x14a\xa4d\x8dK\x82\xee\x8a\x19\x85\x8d'\xe0\x97"
    b'\xc4\x7f\x88\xf7ZN\xad\xf1CQ\xb6\xf0\x86\x87\xa6j\xfan\xbdi'
    b"\xe1\xcd%\xa3\xbc\xd4n'\xb2\xbb\x86\xf2\xd4_\xde\xba\x98b_2"
    b'5Ymm\xa3r\x1e R\xf9\xd1\x99\x0f\xd0\xf4QE\x14W\xe2'
    b'\xb7\xfc\x16\xaf\xfeN\x9f\xc2\xdf\xf6O\xec\x7f\xf4\xe3\xa8\xd7\xea\xa7\xec'
    b'\x9d\xff\x00&\xb1\xf0o\xfe\xc9\xff\x00\x87\xbf\xf4\xdd\x05z\xad\x14Q'
    b'E\x15\xe6\x1f\x12~\x05i\xbe5\xf1\x13|A\xf0\xe7\x8a5_\x0b'
    b'x\xcdt\xf84\xc1\xa9[\xbf\xdam.\xed`\x92y`\xb5\xbc\xb1'
    b'\x94\x98\xa5\x84Mq#\x17\x8b\xc9\xb9\xda\xce\x91\xdcD\x1d\xb3\xe6\xfa'
    b'\xae\x9b\xf1\xb7\xe1\xf34~+\xf0"\xf8\xdfM\x8c\x19\x1b^\xf0d'
    b'k\x1b\xc7\x12\x80\xd2\xbd\xc6\x93s9\xb8B\xa1\xb6\xa4vr\xdf\xcb'
    b'7\x94\xe4$l\xd1\xc2\xc9\xe1\x7f\x1ex[\xc62\xde\xd9\xe8\x9a\x8c'
    b'\x83Q\xd3<\xbf\xed\x1d*\xf6\xd6k\x1dKO\xf3\x03\x18\xbe\xd5e'
    b'p\xa9qo\xe6*\x97O65\xde\x98u\xca\x90M\xef\x12xw'
    b'G\xf1\x7f\x87u_\t\xf8\x8a\xcf\xedzV\xb5e>\x9d}o\xe6'
    b'<~u\xbc\xd1\x98\xe4M\xc8C.U\x88\xca\x90Fx \xd5o'
    b'\xd9\x97\xe3\xcf\x8d\xbcy\xe2(~\x1fj\xde#\xf0\xe7\xc4\xed2\xcf'
    b'B\x96\xf2\x7f\x88\xbe\x18\xb3\x96\xda\xc7\xed\xb0Ik\x10\xd3\xee\x923'
    b'=\x9f\xdb$Y\x9e\xe4\xf97(\xc1A\x1fe\x89<\xb9$\xfaN'
    b'\x8a(\xa2\x8a\xfcV\xff\x00\x82\xd5\xff\x00\xc9\xd3\xf8[\xfe\xc9\xfd\x8f'
    b'\xfe\x9cu\x1a\xfdT\xfd\x93\xbf\xe4\xd6>\r\xff\x00\xd9?\xf0\xf7\xfe'
    b"\x9b\xa0\xafU\xa2\x8a(\xa2\xbc\xdb\xc6\xff\x00\xb4'\xc3O\x04kW"
    b'>\x127\xfa\x87\x88|Oh\x14M\xa1xwO\x9bR\xbb\xb7\x95'
    b'\xd1^\x08\xae\xccJa\xd3\xcc\xc1\xd4\xc6\xf7\xb2A\x13\r\xcd\xbc"'
    b';/\x87j\xdf\xb5/\xc5/\x89\xba\xc5\xef\x85\xfe\x0chpY\xdd'
    b'ZK%\x8d\xee\x97\xa6\xc3k\xe2/\x11\xda\xb8\xcaJ.\xa5\x8e\xe9'
    b'4}\n\xe23\x15\xc3C\xf6\xcb\x9b\xa4\x9fn<\xaf27\xb6}'
    b'\xcf\n~\xc6\xd1\xf8\xcbU\x83\xe2G\xed=\xe2\xcf\x12\xf8\xb3\xc76'
    b'\x85\xd3Jk\x0f\x19\xea6\xd6\xfa\x14L\x86)\r\xab\xd8\xad\x82\t'
    b'g\x8f`\x99\xa2\xb6\xb7FH\xe2C\x1bH\xb3\\\xdc\xfa\x1d\xb7\xec'
    b'\x9b\xfb9,dk\xbf\ttO\x16O\x9f\x96\xf7\xc6"O\x12^'
    b'\xc6\x9d\xa2K\x9dM\xa7\x99"\x07,"W\x08\x19\xdd\x82\x86v\''
    b'\xd6\xe8\xa2\x8a(\xa2\xbf\x15\xbf\xe0\xb5\x7f\xf2t\xfe\x16\xff\x00\xb2\x7f'
    b'c\xff\x00\xa7\x1dF\xbfU?d\xef\xf95\x8f\x83\x7f\xf6O\xfc='
    b'\xff\x00\xa6\xe8+\xd5h\xa2\x8a(\xaf\x19\xd2\xbfc\xaf\xd9\xa7I\xf3'
    b'\xad\xd3\xe1N\x9f}\xa5I<\xf71h:\xad\xd5\xce\xa3\xa1\xdaM'
    b'4\xad+\xc9k\xa5\xdc\xc9%\x95\xabny6\xb40\xa1E\x92E'
    b"]\xaa\xec\xa7\xd6\xf4\x9d'J\xd04\xab-\x0bB\xd3-4\xed7"
    b'N\xb7\x8e\xd2\xce\xce\xd2\x15\x86\x0bh#P\xb1\xc5\x1cj\x02\xa2*'
    b'\x80\xa1@\x00\x00\x00\xabtQE\x14QE\x15\xf8\xad\xff\x00\x05\xab'
    b'\xff\x00\x93\xa7\xf0\xb7\xfd\x93\xfb\x1f\xfd8\xea5\xf0\x05\x14QE\x14'
    b'QE\x14QE\x14QE\x14W\xff\xd9'
)

# ===== MAIN =====
display = PicoGraphics(display=DISPLAY_INKY_PACK)

try:
    display.set_pen(WHITE); display.clear()
    display.set_pen(BLACK); display.set_font("bitmap8")
    display.text("Connecting...", 10, 55, scale=1)
    display.update()

    if not connect_wifi():
        show_error(display, "WiFi failed"); raise SystemExit

    lat, lon, city = get_location()
    data     = get_weather(lat, lon)
    cw       = data["current_weather"]
    daily    = data["daily"]

    temp     = int(cw["temperature"])
    desc     = WMO.get(int(cw["weathercode"]), "?")
    hmax     = int(daily["temperature_2m_max"][0])
    hmin     = int(daily["temperature_2m_min"][0])
    tmax     = int(daily["temperature_2m_max"][1])
    tmin     = int(daily["temperature_2m_min"][1])
    tmr_desc = WMO.get(int(daily["weathercode"][1]), "?")
    date_str = parse_time(cw.get("time", ""))
    gc.collect()

    # --- DRAW ---
    display.set_pen(WHITE); display.clear()

    # 1. UK map (correct proportions, letterboxed)
    j = jpegdec.JPEG(display)
    j.open_RAM(UK_MAP)
    j.decode(MAP_X, MAP_Y)

    # 2. Mask left panel
    display.set_pen(WHITE); display.rectangle(0, 0, MAP_X, 128)

    # 3. Header
    display.set_pen(BLACK); display.rectangle(0, 0, 296, 14)
    display.set_pen(WHITE); display.set_font("bitmap6")
    display.text(city[:14], 3, 4, scale=1)
    display.text(date_str, 200, 4, scale=1)

    # 4. Left: today
    display.set_pen(BLACK); display.set_font("bitmap8")
    display.text("{}C".format(temp), 4, 18, scale=3)
    display.set_font("bitmap6")
    display.text(desc, 4, 58, scale=1)
    display.text("H:{}  L:{}".format(hmax, hmin), 4, 70, scale=1)

    # 5. Left: tomorrow
    display.set_pen(BLACK); display.line(4, 84, 143, 84)
    display.set_font("bitmap8"); display.text("Tmr", 4, 90, scale=1)
    display.set_font("bitmap6")
    display.text(tmr_desc, 4, 104, scale=1)
    display.text("H:{}  L:{}".format(tmax, tmin), 4, 115, scale=1)

    # 6. Divider
    display.set_pen(BLACK); display.line(148, 14, 148, 127)

    # 7. Location dot
    if city in CITY_DOTS:
        dx, dy = CITY_DOTS[city]
    else:
        dx, dy = latlon_to_dot(lat, lon)
    display.set_pen(BLACK); display.circle(dx, dy, 5)
    display.set_pen(WHITE); display.circle(dx, dy, 2)
    display.set_pen(BLACK)

    display.line(0, 127, 295, 127)
    display.update()

except Exception as e:
    try:
        show_error(display, e)
    except Exception:
        pass
    raise
